# Binary Patching

The original assignment webpage put up by my professor is "quiz 0x01 - CS6332-F2019 @ UTD.html", along with the related files folder.
The original files we worked on are crackme0x00, crackme0x01, and crackme0x02. The download links in the original webpage link to modified files created for later assignments.

I used radare2 to analyze the exectuables and edit the assembly. I open them in writable mode using the -w flag, "r2 -w crackme0x0-".
After opening the file I typically run the following commands: `s main` to jump r2 to the main() function of the C program, and `aaaa` to make r2 analyze the program. I then press `v` and cycle to the assembly view by pressing `p`.

# Part 2
For part 2, I changed the program to make it accept a password of my choice. As generated by the command on the website, my secret number is 53108. Let's look at this in more detail with crackme0x00 and crackme0x01.

For **crackme0x00**, the screen after cycling to the assembly view looks as follows:
![crackme0x00](https://github.com/BradROlbrey/binary-patching/blob/screen_captures/captures_crackme0x00/1_cropped.png?raw=true)
Looking towards the bottom of the assembly, r2 shows us some branching logic, with parts corresponding to `"Invalid password"` and `"Password OK"`. Above that we can see a `strcmp`, a string `"250382"` getting loaded from memory, and a `scanf` getting input from the user. So the program must compare the user's input to the hardcoded password and branch appropriately.
![crackme0x00](https://github.com/BradROlbrey/binary-patching/blob/screen_captures/captures_crackme0x00/4_runs_original.png?raw=true)

On the line where the password is loaded, we can see the address it is loaded up from, so we jump to that location by `q`'ing back to the initial r2 screen, seeking to it with `s 0x0804858f`, and returning to the assembly view with `v`. This brings us to the following screen:
![crackme0x00](https://github.com/BradROlbrey/binary-patching/blob/screen_captures/captures_crackme0x00/2_cropped.png?raw=true)
Since we opened the executable in write mode, we can edit the line we are on by pressing `A`, and replace the hardcoded password with our own by typing `.string "53108"`.
![crackme0x00](https://github.com/BradROlbrey/binary-patching/blob/screen_captures/captures_crackme0x00/3_cropped.png?raw=true)
With that, we can save changes, `q` out of radare2, and test the program.

It fails with the original password:
![crackme0x01](https://github.com/BradROlbrey/binary-patching/blob/screen_captures/captures_crackme0x00/4_runs_updated_fail.png?raw=true)
But succeeds with the updated password:
![crackme0x01](https://github.com/BradROlbrey/binary-patching/blob/screen_captures/captures_crackme0x00/4_runs_updated_success.png?raw=true)

-------------------------------

For **crackme0x01**, the secret is a hexadecimal number, 0x149a, which is 5274 in decimal.
![crackme0x01](https://raw.githubusercontent.com/BradROlbrey/binary-patching/screen_captures/captures_crackme0x01_p2/1_cropped.png)

To change this to my secret number, which is 0xcf74 in hex, I entered edit mode at the particular line of code where the comparison takes place (address 0x0804842b).
Despite using the notation itself, r2 doesn't like when we try to type `cmp dword [local_4h], 0xcf74` as our assembly.
![crackme0x01](https://raw.githubusercontent.com/BradROlbrey/binary-patching/screen_captures/captures_crackme0x01_p2/2_cropped.png)
However, we can see at the top of main in the first picture that `local_4h` is simply r2's shorthand for `ebp-0x4`. So if we type `cmp dword [ebp-0x4], 0xcf74`
![crackme0x01](https://raw.githubusercontent.com/BradROlbrey/binary-patching/screen_captures/captures_crackme0x01_p2/3_cropped.png)
It works as expected
![crackme0x01](https://raw.githubusercontent.com/BradROlbrey/binary-patching/screen_captures/captures_crackme0x01_p2/4_cropped.png)


# Part 3
To change the execution of the program, I replaced existing lines of assembly with NOPs as necessary to make program print "Password OK" no matter the input, getting rid of the branching statement and any code related to the "Invalid password" output.

For **assign0x01**, I replaced all lines from address 0x0804842b (inclusive) after the scanf to 0x08048442 (exclusive) before the password ok.

Here's what the main() function looks like before:
![crackme0x01](https://github.com/BradROlbrey/binary-patching/blob/screen_captures/captures_crackme0x01_p3/1_cropped.png?raw=true)

Let's zoom in and enhance to the line right after call `sym.imp.scanf`. We can see that this line is 7 bytes. Each nop is one byte, so we must add 7 nops to replace this line.
![crackme0x01](https://github.com/BradROlbrey/binary-patching/blob/screen_captures/captures_crackme0x01_p3/2.1_cropped.png?raw=true)
![crackme0x01](https://github.com/BradROlbrey/binary-patching/blob/screen_captures/captures_crackme0x01_p3/2.2_cropped.png?raw=true)
![crackme0x01](https://github.com/BradROlbrey/binary-patching/blob/screen_captures/captures_crackme0x01_p3/2.3_cropped.png?raw=true)
![crackme0x01](https://github.com/BradROlbrey/binary-patching/blob/screen_captures/captures_crackme0x01_p3/2.4_cropped.png?raw=true)
![crackme0x01](https://github.com/BradROlbrey/binary-patching/blob/screen_captures/captures_crackme0x01_p3/2.5_cropped.png?raw=true)
![crackme0x01](https://github.com/BradROlbrey/binary-patching/blob/screen_captures/captures_crackme0x01_p3/2.6_cropped.png?raw=true)
![crackme0x01](https://github.com/BradROlbrey/binary-patching/blob/screen_captures/captures_crackme0x01_p3/2.7_cropped.png?raw=true)
![crackme0x01](https://github.com/BradROlbrey/binary-patching/blob/screen_captures/captures_crackme0x01_p3/2.8_cropped.png?raw=true)

We do this with the remaining lines.
![crackme0x01](https://github.com/BradROlbrey/binary-patching/blob/screen_captures/captures_crackme0x01_p3/3_cropped.png?raw=true)

We can now give any input to the program.
![crackme0x01](https://github.com/BradROlbrey/binary-patching/blob/screen_captures/captures_crackme0x01_p3/4_cropped.png?raw=true)

------------
For **crackme0x02**, the password looks a little obfuscated, but it doesn't matter since we're just going to insert nops, not our own password.
![crackme0x01](https://github.com/BradROlbrey/binary-patching/blob/screen_captures/captures_crackme0x02/1_cropped.png?raw=true)

We simply need to get rid of the `jne` by inserting two nops in its place.
![crackme0x01](https://github.com/BradROlbrey/binary-patching/blob/screen_captures/captures_crackme0x02/2_cropped.png?raw=true)

The program will always print password ok and jump past the invalid password section, accepting whatever we input.
![crackme0x01](https://github.com/BradROlbrey/binary-patching/blob/screen_captures/captures_crackme0x02/3_cropped.png?raw=true)
